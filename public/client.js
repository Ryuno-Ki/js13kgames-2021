/**
 * This file is part of JS13kGames - SPACE.
 * Lido Space is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * Lido Space is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with Lido Space.  If not, see <https://www.gnu.org/licenses/>.
 */

var lido=function(t){"use strict";var e={avatars:[],downTime:0,edges:null,host:null,hostPoints:[],isPressed:!1,opponentPoints:[],opponentsState:null,role:ROLE_UNKNOWN,roleState:null,socket:null,socketState:null,spectatorsState:null,startTime:0,upTime:0};function n(t){if(null===e.socketState)throw new Error("HTML broken");e.socketState.textContent=t}function o(){n("Connected and waiting for opponent…")}function r(){n("Connection lost!")}function s(){n("Waiting for opponent…")}function i(){n("Connection error!")}function a(t){console.log(t)}function c(){a("You lost")}function u(){var t=[160,100],n=[].concat([t]);return e.hostPoints.forEach((function(e){var o,r=t[0],s=t[1],i=function(t){var e=t.radius,n=t.angle;return{x:e*Math.cos(n),y:e*Math.sin(n)}}({radius:130*Math.random(),angle:(o=360*e/13,o*Math.PI/180)}),a=i.x,c=i.y;n.push([r+a,s+c]),n.push([r,s])})),n.slice(-26)}function p(){if(null===e.host)throw new Error("Game not properly initialised!");var t=u().map((function(t){return t.join(",")})).join(" ");e.host.setAttribute("points",t)}function l(t){var o=t.role,r=t.opponents,s=t.spectators;e.role=o,function(t){var n=t.role,o=t.opponents,r=t.spectators;if(!e.opponentsState||!e.roleState||!e.spectatorsState)throw new Error("Bogus HTML");e.roleState.textContent=n,e.opponentsState.textContent=o+"",e.spectatorsState.textContent=r+""}({role:o,opponents:r,spectators:s}),o===ROLE_HOST&&(document.body.addEventListener("keydown",(function(t){"Space"===t.code&&(t.preventDefault(),e.isPressed||(e.downTime=(new Date).valueOf(),e.isPressed=!0))}),!1),document.body.addEventListener("keyup",(function(t){"Space"===t.code&&(t.preventDefault(),function(){e.upTime=(new Date).valueOf();var t=e.upTime-e.downTime;Number.isNaN(t/1e3)||(e.hostPoints.push((e.startTime-e.upTime)/1e3),p(),e.socket.emit("keyUp",{delta:(e.startTime-e.upTime)/1e3,position:null,role:e.role})),e.isPressed=!1}())}),!1)),o===ROLE_OPPONENT&&(function(){if(!e.edges)throw new Error("Boom");var t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"circle");switch(n.setAttribute("r","1"),function(t){var e=t.length;return t[Math.floor(Math.random()*e)]}([0,1,2,3])){case 0:n.setAttribute("cx","160"),n.setAttribute("cy","0"),e.opponentPoints.push([160,0]);break;case 1:n.setAttribute("cx","100"),n.setAttribute("cy","0"),e.opponentPoints.push([100,0]);break;case 2:n.setAttribute("cx","100"),n.setAttribute("cy","320"),e.opponentPoints.push([100,320]);break;case 3:n.setAttribute("cx","160"),n.setAttribute("cy","200"),e.opponentPoints.push([160,200])}e.edges.appendChild(n);var o=document.createElementNS(t,"polygon");e.edges.appendChild(o)}(),function(){if(!e.edges)throw new Error("Boom");var t=e.edges.children[0],n=e.edges.children[1];document.body.addEventListener("keyup",(function(o){switch(o.code){case"ArrowUp":o.preventDefault(),function(t){var e=t.getAttribute("cy");if(null===e)throw new Error("Boom");(e=parseInt(e,10))>0&&t.setAttribute("cy",Math.max(e-2,0)+"")}(t);break;case"ArrowRight":o.preventDefault(),function(t){var e=t.getAttribute("cx");if(null===e)throw new Error("Boom");(e=parseInt(e,10))<=320&&t.setAttribute("cx",Math.min(e+3.2,320)+"")}(t);break;case"ArrowDown":o.preventDefault(),function(t){var e=t.getAttribute("cy");if(null===e)throw new Error("Boom");(e=parseInt(e,10))<=200&&t.setAttribute("cy",Math.min(e+2,200)+"")}(t);break;case"ArrowLeft":o.preventDefault(),function(t){var e=t.getAttribute("cx");if(null===e)throw new Error("Boom");(e=parseInt(e,10))>0&&t.setAttribute("cx",Math.max(e-3.2,0)+"")}(t)}var r=t.getAttribute("cx"),s=t.getAttribute("cy");if(r&&s){e.opponentPoints.push([r,s]);var i=e.opponentPoints.map((function(t){return t.join(",")})).join(" ");n.setAttribute("points",i),e.socket.emit("keyUp",{delta:null,position:{cx:r,cy:s},role:e.role})}}),!1)}()),n("Playing")}function d(t){var n=t.delta,o=t.position,r=t.role;if(r===ROLE_HOST&&(e.hostPoints.push(n),p()),r===ROLE_OPPONENT&&e.edges){var s;if(0===e.edges.children.length){var i="http://www.w3.org/2000/svg";(s=document.createElementNS(i,"circle")).setAttribute("r","1"),e.edges.append(s);var a=document.createElementNS(i,"polygon");e.edges.appendChild(a)}else s=e.edges.children[0];var c=o.cx,u=o.cy;s.setAttribute("cx",c),s.setAttribute("cy",u),e.opponentPoints.push([parseInt(c,10),parseInt(u,10)]),function(){if(!e.edges)throw new Error("Boom");var t=e.edges.children[1];if(!t)throw new Error("Boom");var n=e.opponentPoints.map((function(t){return t.join(",")})).join(" ");t.setAttribute("points",n)}()}}function f(){a("You win!")}function w(){e.hostPoints=[],e.socket=window.io({upgrade:!1,transports:["websocket"]}),function(t){t.host=function(){var t=document.getElementById("host");if(!t)throw new Error("Cannot start game!");return t}(),t.edges=function(){var t=document.getElementById("edges");if(!t)throw new Error("Cannot start game!");return t.innerHTML="",t}(),t.socketState=function(){var t=document.getElementById("socketState");if(!t)throw new Error("Cannot start game!");return t}(),t.roleState=function(){var t=document.getElementById("role");if(!t)throw new Error("Cannot start game!");return t}(),t.opponentsState=function(){var t=document.getElementById("opponents");if(!t)throw new Error("Cannot start game!");return t}(),t.spectatorsState=function(){var t=document.getElementById("spectators");if(!t)throw new Error("Cannot start game!");return t}()}(e),function(){if(null===e.socket)throw new Error("Game not properly initialised!");e.socket.on("start",l),e.socket.on("sync",d),e.socket.on("win",f),e.socket.on("lose",c),e.socket.on("end",s),e.socket.on("connect",o),e.socket.on("disconnect",r),e.socket.on("error",i)}(),e.startTime=(new Date).valueOf(),p()}return t.app=function(){window.addEventListener("load",w,!1)},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
