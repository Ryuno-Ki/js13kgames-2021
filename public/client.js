/**
 * This file is part of JS13kGames - SPACE.
 * Lido Space is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * Lido Space is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with Lido Space.  If not, see <https://www.gnu.org/licenses/>.
 */

var lido=function(t){"use strict";var e={avatars:[],edges:null,host:null,opponentsState:null,roleState:null,socket:null,socketState:null,spectatorsState:null};function n(t){if(null===e.socketState)throw new Error("HTML broken");e.socketState.textContent=t}function o(){n("Connected and waiting for opponent…")}function r(){n("Connection lost!")}function i(){n("Waiting for opponent…")}function a(){n("Connection error!")}var s={downTime:0,hostPoints:[],isPressed:!1,mode:null,name:null,opponentPoints:[],role:ROLE_UNKNOWN,startTime:0,upTime:0};function c(){var t=[160,100],e=[].concat([t]);return s.hostPoints.forEach((function(n){var o,r=t[0],i=t[1],a=function(t){var e=t.radius,n=t.angle;return{x:e*Math.cos(n),y:e*Math.sin(n)}}({radius:130*Math.random(),angle:(o=360*n/13,o*Math.PI/180)}),s=a.x,c=a.y;e.push([r+s,i+c]),e.push([r,i])})),e.slice(-26)}function u(){if(null===e.host)throw new Error("Game not properly initialised!");var t=c().map((function(t){return t.join(",")})).join(" ");e.host.setAttribute("points",t)}function l(t){var o=t.role,r=t.opponents,i=t.spectators;s.role=o,function(t){var n=t.role,o=t.opponents,r=t.spectators;if(!e.opponentsState||!e.roleState||!e.spectatorsState)throw new Error("Bogus HTML");e.roleState.textContent=n,e.opponentsState.textContent=o+"",e.spectatorsState.textContent=r+""}({role:o,opponents:r,spectators:i}),o===ROLE_HOST&&(document.body.addEventListener("keydown",(function(t){"Space"===t.code&&(t.preventDefault(),s.isPressed||(s.downTime=(new Date).valueOf(),s.isPressed=!0))}),!1),document.body.addEventListener("keyup",(function(t){"Space"===t.code&&(t.preventDefault(),function(){s.upTime=(new Date).valueOf();var t=s.upTime-s.downTime;Number.isNaN(t/1e3)||(s.hostPoints.push((s.startTime-s.upTime)/1e3),u(),e.socket.emit("keyUp",{delta:(s.startTime-s.upTime)/1e3,position:null,role:s.role})),s.isPressed=!1}())}),!1)),o===ROLE_OPPONENT&&(function(){if(!e.edges)throw new Error("Boom");var t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"circle");switch(n.setAttribute("r","1"),function(t){var e=t.length;return t[Math.floor(Math.random()*e)]}([0,1,2,3])){case 0:n.setAttribute("cx","160"),n.setAttribute("cy","0"),s.opponentPoints.push([160,0]);break;case 1:n.setAttribute("cx","100"),n.setAttribute("cy","0"),s.opponentPoints.push([100,0]);break;case 2:n.setAttribute("cx","100"),n.setAttribute("cy","320"),s.opponentPoints.push([100,320]);break;case 3:n.setAttribute("cx","160"),n.setAttribute("cy","200"),s.opponentPoints.push([160,200])}e.edges.appendChild(n);var o=document.createElementNS(t,"polygon");e.edges.appendChild(o)}(),function(){if(!e.edges)throw new Error("Boom");var t=e.edges.children[0],n=e.edges.children[1];document.body.addEventListener("keyup",(function(o){switch(o.code){case"ArrowUp":o.preventDefault(),function(t){var e=t.getAttribute("cy");if(null===e)throw new Error("Boom");(e=parseInt(e,10))>0&&t.setAttribute("cy",Math.max(e-2,0)+"")}(t);break;case"ArrowRight":o.preventDefault(),function(t){var e=t.getAttribute("cx");if(null===e)throw new Error("Boom");(e=parseInt(e,10))<=320&&t.setAttribute("cx",Math.min(e+3.2,320)+"")}(t);break;case"ArrowDown":o.preventDefault(),function(t){var e=t.getAttribute("cy");if(null===e)throw new Error("Boom");(e=parseInt(e,10))<=200&&t.setAttribute("cy",Math.min(e+2,200)+"")}(t);break;case"ArrowLeft":o.preventDefault(),function(t){var e=t.getAttribute("cx");if(null===e)throw new Error("Boom");(e=parseInt(e,10))>0&&t.setAttribute("cx",Math.max(e-3.2,0)+"")}(t)}var r=t.getAttribute("cx"),i=t.getAttribute("cy");if(r&&i){s.opponentPoints.push([r,i]);var a=s.opponentPoints.map((function(t){return t.join(",")})).join(" ");n.setAttribute("points",a),e.socket.emit("keyUp",{delta:null,position:{cx:r,cy:i},role:s.role})}window.zzfx.apply(window,[,,350,,,.09,4,1.13,,6.9,,,,.9,,.5,,.93,.01,.18])}),!1)}()),n("Playing")}function p(t){var n=t.delta,o=t.position,r=t.role;if(r===ROLE_HOST&&(s.hostPoints.push(n),u()),r===ROLE_OPPONENT&&e.edges){var i;if(0===e.edges.children.length){var a="http://www.w3.org/2000/svg";(i=document.createElementNS(a,"circle")).setAttribute("r","1"),e.edges.append(i);var c=document.createElementNS(a,"polygon");e.edges.appendChild(c)}else i=e.edges.children[0];var l=o.cx,p=o.cy;i.setAttribute("cx",l),i.setAttribute("cy",p),s.opponentPoints.push([parseInt(l,10),parseInt(p,10)]),function(){if(!e.edges)throw new Error("Boom");var t=e.edges.children[1];if(!t)throw new Error("Boom");var n=s.opponentPoints.map((function(t){return t.join(",")})).join(" ");t.setAttribute("points",n)}()}}var d="addUser",f="selectMode";function m(t){var e,n,o=new URL(window.location.href);o.hash="#scene-"+t,window.history.pushState({},"",o.href),window.location.hash=o.hash,Array.from(document.querySelectorAll("section")).forEach((function(t){return t.style.display="none"})),e=o.hash,(n=document.querySelector(e))&&(n.style.display="")}function h(){s.hostPoints=[],e.socket=window.io({upgrade:!1,transports:["websocket"]}),function(t){t.host=function(){var t=document.getElementById("host");if(!t)throw new Error("Cannot start game!");return t}(),t.edges=function(){var t=document.getElementById("edges");if(!t)throw new Error("Cannot start game!");return t.innerHTML="",t}(),t.socketState=function(){var t=document.getElementById("socketState");if(!t)throw new Error("Cannot start game!");return t}(),t.roleState=function(){var t=document.getElementById("role");if(!t)throw new Error("Cannot start game!");return t}(),t.opponentsState=function(){var t=document.getElementById("opponents");if(!t)throw new Error("Cannot start game!");return t}(),t.spectatorsState=function(){var t=document.getElementById("spectators");if(!t)throw new Error("Cannot start game!");return t}()}(e),function(){if(null===e.socket)throw new Error("Game not properly initialised!");e.socket.on("start",l),e.socket.on("sync",p),e.socket.on("end",i),e.socket.on("connect",o),e.socket.on("disconnect",r),e.socket.on("error",a)}(),s.startTime=(new Date).valueOf(),function(){var t=document.getElementById("user-form");if(!t)throw new Error("Cannot start game!");t.addEventListener("submit",(function(t){if(t.preventDefault(),!t.target)throw new Error("Something went wrong!");var n=new FormData(t.target),o=n.get("name"),r=n.get("mode");o&&r?(s.name=String(o),s.mode=String(r),console.log("State",s),e.socket.emit(d,{name:s.name}),e.socket.emit(f,{mode:s.mode}),m("game")):console.error("Show validation error")}))}(),u(),Array.from(document.querySelectorAll("a")).forEach((function(t){t.addEventListener("click",(function(e){e.preventDefault(),m(t.getAttribute("href").slice("#scene-".length))}),!1)})),m("title")}return t.app=function(){window.addEventListener("load",h,!1)},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
