/**
 * This file is part of JS13kGames - SPACE.
 * Lido Space is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * Lido Space is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with Lido Space.  If not, see <https://www.gnu.org/licenses/>.
 */

var lido=function(e){"use strict";var t="Game not properly initialised!",o="addUser",n="keyUp",r="selectMode",i={avatars:[],host:null,opponents:null,opponentsState:null,roleState:null,socket:null,socketState:null,spectatorsState:null};function a(e){if(null===i.socketState)throw new Error("HTML broken");i.socketState.textContent=e}function s(){a("Connected and waiting for opponent…")}function c(){a("Connection lost!")}function l(){a("Waiting for opponent…")}function u(){a("Connection error!")}var f={downTime:0,hostPoints:[],isPressed:!1,mode:null,name:null,opponentPoints:[],role:ROLE_UNKNOWN,startTime:0,upTime:0};function d(){f.isPressed||(f.downTime=(new Date).valueOf(),f.isPressed=!0)}function p(){f.upTime=(new Date).valueOf();var e=(f.upTime-f.downTime)/1e3;Number.isNaN(e)||i.socket.emit(n,{delta:e}),f.isPressed=!1}function m(e){var o=e.role,n=e.host,r=e.opponents,s=e.spectators;if(f.role=o,document.body.dataset.role=o,o===ROLE_HOST){if(function(e){var o=e.role,n=e.host,r=e.opponents,a=e.spectators;if(!i.opponentsState||!i.roleState||!i.spectatorsState)throw new Error(t);i.roleState.innerHTML='<span class="tile" style="--user-color: '+n.color+';">\n    '+n.name+" ("+o+")\n  </span>",i.opponentsState.innerHTML="",r.forEach((function(e){var t='<span class="tile" style="--user-color: '+e.color+';">\n      '+e.name+"\n    </span>";i.opponentsState.innerHTML+=t})),i.spectatorsState.textContent=a.join(", ")}({role:o,host:n,opponents:r,spectators:s}),document.body.addEventListener("keydown",(function(e){"Space"===e.code&&(e.preventDefault(),d())}),!1),document.body.addEventListener("keyup",(function(e){"Space"===e.code&&(e.preventDefault(),p())}),!1),!i.host||!i.opponents)throw new Error(t);i.host.style="stroke: "+n.color;var c=i.opponents;r.forEach((function(e,o){var n=c.children[2*o];if(!n)throw new Error(t);n.style="fill: "+e.color}))}o===ROLE_OPPONENT&&document.body.addEventListener("keyup",(function(e){switch(e.code){case"ArrowUp":e.preventDefault(),w(),y();break;case"ArrowRight":e.preventDefault(),h(),y();break;case"ArrowDown":e.preventDefault(),v(),y();break;case"ArrowLeft":e.preventDefault(),E(),y()}}),!1);var l=Array.from(document.querySelectorAll("#scene-game form"));console.log("Forms",l),l.forEach((function(e){console.log("Form",e),e.addEventListener("submit",(function(t){switch(t.preventDefault(),new FormData(e).get("key")){case"space":d(),p();case"TOP":w(),y();case"LEFT":E(),y();case"BOTTOM":v(),y();case"RIGHT":h(),y()}}))})),a("Playing")}function w(){i.socket.emit(n,{direction:0})}function h(){i.socket.emit(n,{direction:1})}function v(){i.socket.emit(n,{direction:2})}function E(){i.socket.emit(n,{direction:3})}function y(){window.zzfx.apply(window,[,,350,,,.09,4,1.13,,6.9,,,,.9,,.5,,.93,.01,.18])}function k(e){var o=e.points,n=e.role;if(n===ROLE_HOST){if(null===i.host)throw new Error(t);var r=o.map((function(e){return e.join(",")})).join(" ");i.host.setAttribute("points",r)}if(n===ROLE_OPPONENT){if(!i.opponents)throw new Error(t);var a=i.opponents;o.forEach((function(e,o){var n=a.children[2*o],r=a.children[2*o+1],i=e[e.length-1];if(!n||!r)throw new Error(t);var s=i[0],c=i[1];n.setAttribute("cx",s),n.setAttribute("cy",c),f.opponentPoints.push([s,c]);var l=e.join(",");r.setAttribute("points",l)}))}}function S(e){var t,o,n=new URL(window.location.href);n.hash="#scene-"+e,window.history.pushState({},"",n.href),window.location.hash=n.hash,Array.from(document.querySelectorAll("section")).forEach((function(e){e.style.display="none"})),t=n.hash,(o=document.querySelector(t))&&(o.style.display=""),i.socket.emit("navigate",{scene:e})}function g(){f.hostPoints=[],i.socket=window.io({upgrade:!1,transports:["websocket"]}),function(e){e.host=function(){var e=document.getElementById("host");if(!e)throw new Error(t);return e}(),e.opponents=function(){var e=document.getElementById("opponents");if(!e)throw new Error(t);return e}(),e.socketState=function(){var e=document.getElementById("socketState");if(!e)throw new Error(t);return e}(),e.roleState=function(){var e=document.getElementById("role");if(!e)throw new Error(t);return e}(),e.opponentsState=function(){var e=document.getElementById("opponent-list");if(!e)throw new Error(t);return e}(),e.spectatorsState=function(){var e=document.getElementById("spectators");if(!e)throw new Error(t);return e}()}(i),function(){if(null===i.socket)throw new Error(t);i.socket.on("start",m),i.socket.on("sync",k),i.socket.on("end",l),i.socket.on("connect",s),i.socket.on("disconnect",c),i.socket.on("error",u)}(),f.startTime=(new Date).valueOf(),function(){var e=document.getElementById("user-form");if(!e)throw new Error(t);e.addEventListener("submit",(function(e){if(e.preventDefault(),!e.target)throw new Error(t);var n=new FormData(e.target).get("name");n?(f.name=String(n),console.log("State",f),i.socket.emit(o,{name:f.name}),S("match-form")):console.error("Show validation error")}))}(),function(){var e=document.getElementById("match-form");if(!e)throw new Error(t);e.addEventListener("submit",(function(e){if(e.preventDefault(),!e.target)throw new Error(t);var o=new FormData(e.target).get("mode");o?(f.mode=String(o),console.log("State",f),i.socket.emit(r,{mode:f.mode}),S("game")):console.error("Show validation error")}))}(),Array.from(document.querySelectorAll("a")).forEach((function(e){e.addEventListener("click",(function(t){var o=e.getAttribute("href");o&&(t.preventDefault(),S(o.slice("#scene-".length)))}),!1)})),S("title")}return e.app=function(){window.addEventListener("load",g,!1)},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
